<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Halloween Haunted Hunt â€” Fixed</title>
<style>
  :root{--ui-bg:rgba(0,0,0,0.6);}
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial;}
  body{background:#111;color:#fff;overflow:hidden}
  canvas{display:block; width:100vw;height:100vh;background:#1f3412;}
  #topbar{
    position:fixed; right:14px; top:12px; display:flex; align-items:center; gap:8px;
    background:var(--ui-bg); padding:6px 10px; border-radius:10px;
  }
  #topbar img{width:28px;height:28px}
  #topbar .score{font-weight:700;font-size:20px}
  #targetThumb{
    position:fixed; left:50%; transform:translateX(-50%); top:8px;
    background:var(--ui-bg); padding:6px 10px; border-radius:10px; display:flex; align-items:center; gap:8px;
    min-width:160px; justify-content:center; visibility:hidden;
  }
  #targetThumb img{width:36px;height:36px;object-fit:contain}
  #controls{position:fixed; left:0; bottom:0; right:0; pointer-events:none;}
  #joystick{
    position:absolute; left:14px; bottom:14px; width:140px; height:140px; border-radius:12px;
    background:rgba(255,255,255,0.04); pointer-events:auto; display:flex; align-items:center; justify-content:center;
  }
  #joypad{
    width:70px;height:70px;border-radius:50%; background:rgba(255,255,255,0.10); position:relative; touch-action:none;
  }
  #spawnBtn{
    position:absolute; right:14px; bottom:14px; pointer-events:auto;
    background:linear-gradient(180deg,#ff8a00,#d65a00); border:none; color:#111;
    padding:12px 16px;border-radius:12px;font-weight:700; box-shadow:0 6px 12px rgba(0,0,0,0.4);
  }
  #actionBar{
    position:fixed; left:50%; transform:translateX(-50%); bottom:18px; pointer-events:auto;
    background:var(--ui-bg); padding:6px;border-radius:12px; display:flex; gap:10px; align-items:center;
  }
  .actionBtn{background:#fff;border-radius:8px;padding:6px 8px;display:flex;gap:8px;align-items:center;cursor:pointer; position:relative}
  .actionBtn.disabled{opacity:0.35;pointer-events:none}
  .cooldownOverlay{position:absolute;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;border-radius:8px;font-weight:700;color:#fff}
  .modal{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:360px; max-width:94%; background:#fff;color:#111;border-radius:12px;padding:12px; display:none; z-index:40;
  }
  .modal h3{margin:0 0 8px 0}
  .storeRow{display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; background:#f4f4f4; margin-bottom:8px}
  .storeRow img{width:48px;height:48px;object-fit:contain}
  .closeBtn{position:absolute; right:8px; top:8px; cursor:pointer; background:#ff6b6b;padding:6px;border-radius:6px;color:white;border:none}
  button.small{padding:6px 8px;border-radius:8px;border:none;background:#2b2b2b;color:white;cursor:pointer}
  button.small:disabled{opacity:0.45; cursor:default}
  .muted{opacity:0.6}
</style>
</head>
<body>
  <canvas id="game"></canvas>

  <div id="targetThumb"><span class="muted">Find:</span><img id="targetImg" src=""><div id="targetText" style="margin-left:6px"></div></div>

  <div id="topbar"><img src="https://i.ibb.co/RTrBDhB4/Halloween-Candy-Corn-PNG-Clip-Art-Image.png" alt="candy"><div class="score" id="score">0</div></div>

  <div id="controls">
    <div id="joystick"><div id="joypad"></div></div>
    <div id="actionBar" aria-hidden="false"></div>
    <button id="spawnBtn">Spawn (center)</button>
  </div>

  <div id="itemStore" class="modal" aria-hidden="true">
    <button class="closeBtn" id="closeItem">X</button>
    <h3>Item Store</h3>
    <div class="storeRow">
      <img src="https://i.ibb.co/bgmg3RpW/IMG-0240.png" alt="locator">
      <div style="flex:1"><strong>Item Locator</strong><div style="font-size:13px" class="muted">Shows arrow to current item</div><div style="font-size:13px;margin-top:6px">Cost: 5 Candy</div></div>
      <div><button id="buyLocator" class="small">Buy</button></div>
    </div>
    <div class="storeRow">
      <img src="https://freesvg.org/img/teleport.png" alt="teleport">
      <div style="flex:1"><strong>Teleporter</strong><div style="font-size:13px" class="muted">Teleport to current item</div><div style="font-size:13px;margin-top:6px">Cost: 20 Candy</div></div>
      <div><button id="buyTeleport" class="small">Buy</button></div>
    </div>
  </div>

  <div id="upgradeStore" class="modal" aria-hidden="true">
    <button class="closeBtn" id="closeUpgrade">X</button>
    <h3>Upgrade Store</h3>
    <div style="font-weight:700">Locator Upgrades (8 Candy each)</div>
    <div class="storeRow">
      <img src="https://i.ibb.co/bgmg3RpW/IMG-0240.png"><div style="flex:1">Upgrade 1: Arrow 3s / CD 4s</div>
      <div><button id="upgLoc1" class="small">Buy</button></div>
    </div>
    <div class="storeRow">
      <img src="https://i.ibb.co/bgmg3RpW/IMG-0240.png"><div style="flex:1">Upgrade 2: Arrow 4s / CD 3s</div>
      <div><button id="upgLoc2" class="small">Buy</button></div>
    </div>
    <div class="storeRow">
      <img src="https://i.ibb.co/bgmg3RpW/IMG-0240.png"><div style="flex:1">Upgrade 3: Arrow 5s / CD 2s (MAX)</div>
      <div><button id="upgLoc3" class="small">Buy</button></div>
    </div>
    <div style="height:8px"></div>
    <div style="font-weight:700">Teleport Upgrades (8 Candy each)</div>
    <div class="storeRow">
      <img src="https://freesvg.org/img/teleport.png"><div style="flex:1">Upgrade 1: CD 25s</div>
      <div><button id="upgTp1" class="small">Buy</button></div>
    </div>
    <div class="storeRow">
      <img src="https://freesvg.org/img/teleport.png"><div style="flex:1">Upgrade 2: CD 20s</div>
      <div><button id="upgTp2" class="small">Buy</button></div>
    </div>
    <div class="storeRow">
      <img src="https://freesvg.org/img/teleport.png"><div style="flex:1">Upgrade 3: CD 15s (MAX)</div>
      <div><button id="upgTp3" class="small">Buy</button></div>
    </div>
  </div>

<script>
/* ======== INITIAL SETUP ======== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function fit(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
fit(); window.addEventListener('resize', fit);

const AVATARS = [
  "https://i.ibb.co/Fq4c4DFn/966891-3652a.gif",
  "https://i.ibb.co/DDxBbjDb/pngtree-halloween-pumpkin-with-candies-pumpkin-trick-or-treat-bag-halloween-pumpkin-png-image-103243.png",
  "https://i.ibb.co/X1yfLRm/pngtree-happy-candy-corn-character-png-image-13841752.png",
  "https://i.ibb.co/K3SYj33/IMG-0212.png",
  "https://i.ibb.co/RTpTfb4Z/IMG-0213.gif",
  "https://i.ibb.co/zWkTcMVqS/mumy-paklet.png",
  "https://i.ibb.co/Xf4p0fw6/200w.gif",
  "https://i.ibb.co/N6rmPVqS/giphy.webp"
];
const ITEM_IMAGES = AVATARS.slice();

const world = { width: 3000, height: 2200 };
let player = { x: world.width/2, y: world.height/2, w:48, h:48, speed:3.6, img:null };
const CENTER = { x: world.width/2, y: world.height/2 };
const itemStorePos = { x: CENTER.x - 120, y: CENTER.y, w:64, h:64 };
const upgradeStorePos = { x: CENTER.x + 120, y: CENTER.y, w:64, h:64 };

function cam(){ return { x: player.x - canvas.width/2, y: player.y - canvas.height/2 }; }

(function pickAvatar(){
  const i = Math.floor(Math.random()*AVATARS.length);
  const img = new Image(); img.src = AVATARS[i];
  player.img = img;
})();

let keys = {};
window.addEventListener('keydown', e => keys[e.key]=true);
window.addEventListener('keyup', e => keys[e.key]=false);

/* joystick */
const joypad = document.getElementById('joypad');
let joy = { active:false, x:0,y:0 };
joypad.addEventListener('pointerdown', e=>{ joy.active=true; joy.startX=e.clientX; joy.startY=e.clientY; });
window.addEventListener('pointermove', e=>{ if(joy.active){ joy.x=e.clientX-joy.startX; joy.y=e.clientY-joy.startY; }});
window.addEventListener('pointerup', e=>{ joy.active=false; joy.x=0; joy.y=0; });

/* state & store */
let state = { candy:50, has:{locator:false,teleport:false}, upgrades:{locator:0,teleport:0} };

/* spawned item */
let spawnedItem = null;
let arrowActiveUntil=0;

/* ======== FUNCTIONS ======== */
function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function showTargetThumb(src){ 
  document.getElementById('targetThumb').style.visibility='visible';
  document.getElementById('targetImg').src = src;
  document.getElementById('targetText').textContent = '';
}

function buyItem(type,cost){
  if(state.has[type]) return alert('Already owned!');
  if(state.candy<cost) return alert('Not enough candy!');
  state.candy -= cost;
  state.has[type]=true;
  updateScore();
  renderActionBar();
}
function buyUpgrade(type,level){
  if(level>1 && state.upgrades[type]<level-1) return alert('Buy previous level first!');
  if(state.candy<8) return alert('Not enough candy!');
  state.candy-=8;
  state.upgrades[type]=level;
  updateScore();
  renderActionBar();
}
function updateScore(){ document.getElementById('score').textContent = state.candy; }

/* ======== BUTTONS ======== */
['buyLocator','buyTeleport','upgLoc1','upgLoc2','upgLoc3','upgTp1','upgTp2','upgTp3'].forEach(id=>{
  const btn=document.getElementById(id); if(!btn) return;
  btn.addEventListener('click',()=>handleStoreClick(id));
});
function handleStoreClick(id){
  switch(id){
    case 'buyLocator': buyItem('locator',5); break;
    case 'buyTeleport': buyItem('teleport',20); break;
    case 'upgLoc1': buyUpgrade('locator',1); break;
    case 'upgLoc2': buyUpgrade('locator',2); break;
    case 'upgLoc3': buyUpgrade('locator',3); break;
    case 'upgTp1': buyUpgrade('teleport',1); break;
    case 'upgTp2': buyUpgrade('teleport',2); break;
    case 'upgTp3': buyUpgrade('teleport',3); break;
  }
}

document.getElementById('spawnBtn').addEventListener('click', spawnRandomItem);
document.getElementById('closeItem').addEventListener('click', ()=>{document.getElementById('itemStore').style.display='none'});
document.getElementById('closeUpgrade').addEventListener('click', ()=>{document.getElementById('upgradeStore').style.display='none'});

/* ======== WORLD DRAWING ======== */
const bgImage = new Image();
bgImage.src = 'https://i.ibb.co/MkBQ7kGS/IMG-0206.jpg';

function spawnRandomItem(){
  if(spawnedItem) return;
  const margin = 120;
  const x = Math.random()*(world.width - margin*2)+margin;
  const y = Math.random()*(world.height - margin*2)+margin;
  const idx = Math.floor(Math.random()*ITEM_IMAGES.length);
  const img = new Image(); img.src=ITEM_IMAGES[idx];
  spawnedItem = { x,y,img,id:Date.now() };
  showTargetThumb(img.src);
}

/* ======== ACTION BAR ======== */
function renderActionBar(){
  const bar = document.getElementById('actionBar');
  bar.innerHTML='';
  if(state.has.locator){
    const btn = document.createElement('div'); btn.className='actionBtn';
    btn.textContent='Locate'; btn.addEventListener('click', ()=>{
      if(!spawnedItem) return alert('No item!');
      arrowActiveUntil = Date.now() + 3000 + state.upgrades.locator*1000;
    });
    bar.appendChild(btn);
  }
  if(state.has.teleport){
    const btn = document.createElement('div'); btn.className='actionBtn';
    btn.textContent='Teleport'; btn.addEventListener('click', ()=>{
      if(!spawnedItem) return alert('No item!');
      player.x=spawnedItem.x; player.y=spawnedItem.y;
    });
    bar.appendChild(btn);
  }
}

/* ======== DRAW LOOP ======== */
function draw(){
  const c = cam();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(-c.x,-c.y);

  if(bgImage.complete) ctx.drawImage(bgImage,0,0,world.width,world.height);
  else{ ctx.fillStyle='#23431b'; ctx.fillRect(0,0,world.width,world.height); }

  // grid
  ctx.strokeStyle='rgba(0,0,0,0.12)'; for(let gx=0;gx<world.width;gx+=120){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,world.height);ctx.stroke();}
  for(let gy=0;gy<world.height;gy+=120){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(world.width,gy);ctx.stroke();}

  // stores
  ctx.fillStyle="#f5e6a0"; ctx.fillRect(itemStorePos.x-32,itemStorePos.y-32,64,64);
  ctx.fillStyle="#222"; ctx.font="bold 14px sans-serif"; ctx.fillText("ITEM", itemStorePos.x-18, itemStorePos.y+6);
  ctx.fillStyle="#f5e6a0"; ctx.fillRect(upgradeStorePos.x-32,upgradeStorePos.y-32,64,64);
  ctx.fillStyle="#222"; ctx.fillText("UPG", upgradeStorePos.x-14,upgradeStorePos.y+6);

  // spawned item with orange background
  if(spawnedItem && spawnedItem.img.complete){
    const iw=44, ih=44;
    ctx.fillStyle="orange";
    ctx.fillRect(spawnedItem.x-iw/2-4,spawnedItem.y-ih/2-4,iw+8,ih+8);
    ctx.drawImage(spawnedItem.img,spawnedItem.x-iw/2,spawnedItem.y-ih/2,iw,ih);
  }

  // player
  if(player.img && player.img.complete){
    ctx.drawImage(player.img, player.x-player.w/2, player.y-player.h/2, player.w, player.h);
  }else{
    ctx.fillStyle='orange'; ctx.beginPath(); ctx.arc(player.x,player.y,24,0,Math.PI*2); ctx.fill();
  }

  ctx.restore();
}

/* ======== GAME LOOP ======== */
function loop(){
  // move
  let vx=0,vy=0;
  if(keys['w']||keys['ArrowUp']) vy-=1;
  if(keys['s']||keys['ArrowDown']) vy+=1;
  if(keys['a']||keys['ArrowLeft']) vx-=1;
  if(keys['d']||keys['ArrowRight']) vx+=1;
  if(joy.active){ vx+=joy.x/20; vy+=joy.y/20; }
  const sp=player.speed; const mag=Math.hypot(vx,vy);
  if(mag>0){ player.x+=vx/mag*sp; player.y+=vy/mag*sp; }
  player.x=Math.max(0,Math.min(world.width,player.x));
  player.y=Math.max(0,Math.min(world.height,player.y));

  draw(); requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
